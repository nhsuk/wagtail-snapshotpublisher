{% extends "modeladmin/edit.html" %}
{% load i18n %}

{% block form_actions %}
    <div class="dropdown dropup dropdown-button match-width">
        <button type="submit" class="button action-save button-longrunning" tabindex="3" data-clicked-text="{% trans 'Savingâ€¦' %}" {% if page.locked %}disabled {% endif %}>
            <span class="icon icon-spinner"></span><em>{% trans 'Save' %}</em>
        </button>

        <div class="dropdown-toggle icon icon-arrow-up"></div>
        <ul role="menu">
            {% if user_can_delete %}<li><a href="{{ view.delete_url }}" class="shortcut">{% trans "Delete" %}</a></li>{% endif %}
            <li>
                <input type="submit" name="wssp-action-publish-release" value="{% trans "Publish To A Release" %}" class="button">
            </li>
            <li>
                <input type="submit" name="wssp-action-unpublish-release" value="{% trans "Unpublish From A Release" %}" class="button">
            </li>
        </ul>
    </div>

    {% if 'content_release' in form.fields %}
        <li class="preview">
            <button class="button action-model-preview icon icon-view" data-submit="{% url 'wagtailsnapshotpublisher_custom_admin:preview-model-admin' instance.get_app instance.get_class instance.id %}" data-auto-update="false">Preview</button>
        </li>


        <script>
            let preview = false;

            $(".action-model-preview").click(function (e) {
                preview = true
                e.preventDefault();
                $(this).closest("form").submit();
            });

            $('form').on('submit', function() {
                const form = $(this);
                const form_target = $(this).attr("action");
                if(preview) {
                    preview = false;
                    var formdata = new FormData(this);
                    $.ajax({
                        url: $(".action-model-preview").data("submit"),
                        data: formdata,
                        processData: false,
                        contentType: false,
                        type: "POST",
                        dataType: "text",
                        success: function (){
                            form.attr("action", $(".action-model-preview").data("submit"));
                            form.attr("target", "_blank");
                            form.submit();
                            form.attr("action", form_target);
                            form.attr("target", "");
                        },
                        error: function (){
                            form.submit()
                        }
                    });
                    return false;
                }
            });
        </script>
    {% endif %}
{% endblock %}

